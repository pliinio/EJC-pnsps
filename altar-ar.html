<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Altar Virtual — MindAR UMD (fix)</title>

  <!-- GSAP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

  <!-- A-Frame (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.2.0/dist/aframe.min.js"></script>

  <!-- MindAR UMD builds (IMPORTANTE: NÃO usar type="module" aqui) -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar/dist/mindar-image.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html,body{height:100%;margin:0;background:#000}
    #backBtn{position:fixed;left:10px;top:10px;z-index:9999;padding:10px 14px;background:rgba(0,0,0,.6);color:#fff;border-radius:8px;border:1px solid #fff;cursor:pointer}
    #dbg{position:fixed;right:10px;top:10px;z-index:9999;background:rgba(0,0,0,.5);color:#fff;padding:6px 8px;border-radius:6px;font-size:12px}
  </style>
</head>
<body>
  <button id="backBtn" onclick="location.href='index.html'">Voltar</button>
  <div id="dbg">status: idle</div>

  <!-- scene: autoStart = true se quiser que abra sem gesture (porém mobile pode exigir gesture) -->
  <a-scene mindar-image="imageTargetSrc: ./targets.mind; autoStart: true; uiLoading: no; uiError: no; uiScanning: no"
           vr-mode-ui="enabled: false"
           embedded
           device-orientation-permission-ui="enabled: false">

    <a-assets>
      <a-asset-item id="altarModel" src="./assets/models/altar-compressed.glb"></a-asset-item>
    </a-assets>

    <a-camera look-controls="enabled: false"></a-camera>

    <!-- anchor como detector -->
    <a-entity id="altar-anchor" mindar-image-target="targetIndex: 0"></a-entity>

    <!-- modelo (dentro do anchor como você preferiu originalmente) -->
    <a-gltf-model id="altar" src="#altarModel" position="0 0 0" rotation="0 0 0" scale="0.1 0.1 0.1" visible="false"></a-gltf-model>

    <script>
      (function(){
        const dbg = document.getElementById('dbg');
        const anchor = document.querySelector('#altar-anchor');
        const altar = document.querySelector('#altar');

        function log(s){ dbg.textContent = 'status: ' + s; console.log('[AR]', s); }

        if (!anchor) { log('anchor NÃO encontrado'); return; }
        if (!altar)  { log('altar NÃO encontrado'); return; }

        let modelReady = false;
        let animating = false;

        // aguarda model-loaded
        altar.addEventListener('model-loaded', () => {
          modelReady = true;
          altar.setAttribute('visible','true');   // garantir visibilidade A-Frame
          altar.object3D.scale.set(0,0,0);        // começa escondido (GSAP anima)
          log('model-loaded OK');
        });

        // se por acaso já carregou antes do listener
        setTimeout(() => {
          if (!modelReady && altar.object3D) {
            modelReady = true;
            altar.setAttribute('visible','true');
            altar.object3D.scale.set(0,0,0);
            log('model-ready (fallback)');
          }
        }, 300);

        function doShow(){
          if (!modelReady) { log('targetFound mas modelo não pronto — aguardando'); return; }
          if (!altar.object3D) { log('altar.object3D ausente'); return; }
          if (animating) { log('já animando, pulando'); return; }

          animating = true;
          altar.setAttribute('visible','true');
          altar.object3D.scale.set(0,0,0);
          gsap.killTweensOf(altar.object3D.scale);
          gsap.to(altar.object3D.scale, {
            x: 0.4, y: 0.4, z: 0.4,
            duration: 1.2,
            ease: "elastic.out(0.4, 0.2)",
            onComplete: () => { animating = false; log('animação completa'); }
          });
        }

        function onLost(){
          animating = false;
          // manter visível no tamanho final (ou esconder se quiser)
          if (altar.object3D) altar.object3D.scale.set(0.4,0.4,0.4);
          log('target lost');
        }

        anchor.addEventListener('targetFound', (e) => {
          log('targetFound event');
          doShow();
        });
        anchor.addEventListener('targetLost', (e) => {
          onLost();
        });

        // exposição útil para debug no console:
        window.__AR_forceShow = () => doShow();
        window.__AR_forceHide = () => { if (altar.object3D) altar.object3D.scale.set(0,0,0); altar.setAttribute('visible','false'); };

        log('listeners prontos — aguarde detecção do gatilho');

      })();
    </script>

  </a-scene>
</body>
</html>
