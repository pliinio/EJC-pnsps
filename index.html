<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>RA - Encontro de Jovens</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body, html {
      margin: 0; 
      padding: 0; 
      overflow: hidden;
      background: #000;
      font-family: Arial, sans-serif;
      width: 100vw;
      height: 100vh;
    }
    
    #container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      font-size: 1.2em;
      text-align: center;
    }
    
    .spinner {
      border: 4px solid #333;
      border-top: 4px solid gold;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    #legend {
      position: fixed;
      bottom: 20px;
      left: 0;
      width: 100%;
      text-align: center;
      color: white;
      font-size: 1.3em;
      text-shadow: 0 0 5px black;
      pointer-events: none;
      z-index: 10;
      background: rgba(0,0,0,0.7);
      padding: 10px;
    }
    
    .fallback {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      color: white;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 20px;
      z-index: 2000;
    }
    
    .btn {
      background: gold;
      color: #8B4513;
      border: none;
      padding: 15px 30px;
      margin: 10px;
      border-radius: 25px;
      font-size: 1.1em;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }
  </style>

  <!-- CARREGAMENTO TRADICIONAL - SEM M√ìDULOS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image-three.prod.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/jsm/loaders/GLTFLoader.min.js"></script>
</head>

<body>
  <div id="loading">
    <div class="spinner"></div>
    <p>Carregando experi√™ncia de Realidade Aumentada...</p>
    <p id="status">Inicializando...</p>
  </div>

  <div id="container"></div>
  <div id="legend"></div>

  <div class="fallback" id="fallback">
    <h2>üéµ Retiro Espiritual - Experi√™ncia Digital</h2>
    <p>A funcionalidade de RA est√° temporariamente indispon√≠vel.</p>
    <p><strong>Todo o conte√∫do espiritual est√° dispon√≠vel abaixo:</strong></p>
    
    <div style="margin: 30px 0;">
      <a href="prayers.html" class="btn">üìñ Ver Todas as Ora√ß√µes</a>
      <a href="https://open.spotify.com/playlist/SUA_PLAYLIST_AQUI" class="btn" target="_blank">üéµ Playlist Spotify</a>
    </div>
    
    <p style="color: #ccc; margin-top: 20px;">
      <em>"A ora√ß√£o √© o encontro da sede de Deus com a nossa sede"</em>
    </p>
  </div>

  <script>
    // Esperar at√© que todas as bibliotecas estejam carregadas
    window.addEventListener('load', function() {
      initializeAR();
    });

    async function initializeAR() {
      const loading = document.getElementById('loading');
      const status = document.getElementById('status');
      const container = document.getElementById('container');
      const legend = document.getElementById('legend');
      const fallback = document.getElementById('fallback');

      function updateStatus(text) {
        status.textContent = text;
        console.log(text);
      }

      function showFallback() {
        loading.style.display = 'none';
        fallback.style.display = 'flex';
      }

      // Verificar se as bibliotecas carregaram
      if (typeof THREE === 'undefined') {
        updateStatus('‚ùå THREE.js n√£o carregou');
        showFallback();
        return;
      }

      if (typeof MindARThree === 'undefined') {
        updateStatus('‚ùå MindAR n√£o carregou');
        showFallback();
        return;
      }

      if (typeof GLTFLoader === 'undefined') {
        updateStatus('‚ùå GLTFLoader n√£o carregou');
        showFallback();
        return;
      }

      try {
        updateStatus('‚úÖ Bibliotecas carregadas - Verificando arquivos...');

        // Verificar se os arquivos existem
        const filesToCheck = [
          './targets.mind',
          './assets/models/altar-compressed.glb',
          './assets/models/livro-compressed.glb'
        ];

        for (const file of filesToCheck) {
          try {
            const response = await fetch(file, { method: 'HEAD' });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            console.log(`‚úÖ ${file} encontrado`);
          } catch (error) {
            console.error(`‚ùå ${file} n√£o encontrado:`, error);
            updateStatus(`‚ùå Arquivo n√£o encontrado: ${file}`);
            showFallback();
            return;
          }
        }

        updateStatus('‚úÖ Arquivos verificados - Iniciando MindAR...');

        // INICIALIZAR MINDAR
        const mindarThree = new MindARThree({
          container: container,
          imageTargetSrc: "./targets.mind",
        });

        const { renderer, scene, camera } = mindarThree;

        // Configurar renderer
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.domElement.style.width = '100%';
        renderer.domElement.style.height = '100%';

        updateStatus('‚úÖ MindAR configurado - Carregando modelos...');

        // LOADER
        const loader = new GLTFLoader();

        // ANCHOR PRINCIPAL
        const anchor = mindarThree.addAnchor(0);
        
        // GRUPO PARA OS MODELOS
        const modelsGroup = new THREE.Group();
        anchor.group.add(modelsGroup);

        let modelsLoaded = 0;
        const totalModels = 3;

        function onModelLoaded(name) {
          modelsLoaded++;
          updateStatus(`Carregando modelos... (${modelsLoaded}/${totalModels})`);
          console.log(`‚úÖ ${name} carregado`);
          
          if (modelsLoaded === totalModels) {
            updateStatus('‚úÖ Todos os modelos carregados!');
          }
        }

        // CARREGAR ALTAR
        loader.load(
          './assets/models/altar-compressed.glb',
          function(gltf) {
            const model = gltf.scene;
            model.scale.set(0.4, 0.4, 0.4);
            model.position.set(0, 0, 0);
            
            // Tornar clic√°vel
            model.traverse(function(child) {
              if (child.isMesh) {
                child.userData.clickable = true;
                child.userData.type = 'altar';
              }
            });
            
            modelsGroup.add(model);
            onModelLoaded('Altar');
          },
          function(progress) {
            // Progresso opcional
          },
          function(error) {
            console.error('‚ùå Erro ao carregar altar:', error);
            onModelLoaded('Altar (com erro)');
          }
        );

        // CARREGAR LIVRO
        loader.load(
          './assets/models/livro-compressed.glb',
          function(gltf) {
            const model = gltf.scene;
            model.scale.set(0.5, 0.5, 0.5);
            model.position.set(1.5, 0.3, 0); // Direita do altar
            model.rotation.set(0, Math.PI / 4, 0);
            
            model.traverse(function(child) {
              if (child.isMesh) {
                child.userData.clickable = true;
                child.userData.type = 'book';
              }
            });
            
            modelsGroup.add(model);
            onModelLoaded('Livro');
          },
          null,
          function(error) {
            console.error('‚ùå Erro ao carregar livro:', error);
            onModelLoaded('Livro (com erro)');
          }
        );

        // BOT√ÉO SPOTIFY
        const spotifyGeometry = new THREE.CylinderGeometry(0.3, 0.3, 0.05, 32);
        const spotifyMaterial = new THREE.MeshBasicMaterial({ 
          color: 0x1DB954,
          transparent: true,
          opacity: 0.9
        });
        const spotifyButton = new THREE.Mesh(spotifyGeometry, spotifyMaterial);
        spotifyButton.position.set(-1.5, 0.3, 0); // Esquerda do altar
        spotifyButton.rotation.set(Math.PI / 2, 0, 0);
        spotifyButton.userData.clickable = true;
        spotifyButton.userData.type = 'spotify';
        modelsGroup.add(spotifyButton);
        onModelLoaded('Spotify');

        // EVENTOS
        anchor.onTargetFound = function() {
          legend.textContent = "Marcador detectado! Clique nos objetos para interagir.";
          console.log('üéØ Marcador encontrado');
        };

        anchor.onTargetLost = function() {
          legend.textContent = "";
          console.log('üëª Marcador perdido');
        };

        // SISTEMA DE CLIQUE
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        renderer.domElement.addEventListener('click', function(event) {
          // S√≥ processar clique se o marcador estiver vis√≠vel
          if (!anchor.target.visible) {
            console.log('Clique ignorado - marcador n√£o vis√≠vel');
            return;
          }

          const rect = renderer.domElement.getBoundingClientRect();
          mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
          mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

          raycaster.setFromCamera(mouse, camera);
          
          // Coletar objetos clic√°veis
          const clickableObjects = [];
          scene.traverse(function(object) {
            if (object.userData.clickable) {
              clickableObjects.push(object);
            }
          });
          
          const intersects = raycaster.intersectObjects(clickableObjects, true);

          if (intersects.length > 0) {
            const clickedObject = intersects[0].object;
            const type = clickedObject.userData.type;
            
            console.log(`Clicou em: ${type}`);
            
            switch(type) {
              case 'altar':
                legend.textContent = "‚ú® Meditando no altar...";
                // Efeito visual
                if (clickedObject.parent) {
                  clickedObject.parent.scale.set(0.45, 0.45, 0.45);
                  setTimeout(function() {
                    clickedObject.parent.scale.set(0.4, 0.4, 0.4);
                  }, 300);
                }
                break;
                
              case 'book':
                legend.textContent = "üìñ Abrindo ora√ß√µes...";
                setTimeout(function() {
                  window.location.href = 'prayers.html';
                }, 800);
                break;
                
              case 'spotify':
                legend.textContent = "üéµ Abrindo Spotify...";
                setTimeout(function() {
                  window.open('https://open.spotify.com/playlist/SUA_PLAYLIST_AQUI', '_blank');
                }, 800);
                break;
            }
          }
        });

        updateStatus('‚úÖ Configura√ß√£o completa - Iniciando c√¢mera...');

        // INICIAR MINDAR
        await mindarThree.start();
        
        updateStatus('‚úÖ RA Pronta! Aponte para o marcador.');
        
        // Esconder loading ap√≥s 2 segundos
        setTimeout(function() {
          loading.style.display = 'none';
        }, 2000);

        // LOOP DE RENDERIZA√á√ÉO
        renderer.setAnimationLoop(function() {
          renderer.render(scene, camera);
        });

        // REDIMENSIONAMENTO
        window.addEventListener('resize', function() {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        });

      } catch (error) {
        console.error('‚ùå Erro fatal:', error);
        updateStatus('‚ùå Erro: ' + error.message);
        showFallback();
      }
    }

    // Timeout de seguran√ßa
    setTimeout(function() {
      const loading = document.getElementById('loading');
      if (loading.style.display !== 'none') {
        document.getElementById('fallback').style.display = 'flex';
        loading.style.display = 'none';
      }
    }, 10000);
  </script>
</body>
</html>
