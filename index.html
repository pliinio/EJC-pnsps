<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>RA - Encontro de Jovens</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html {
      margin: 0; padding: 0; overflow: hidden;
      background: #000; font-family: Arial, sans-serif;
      width: 100vw; height: 100vh;
    }
    #container { position: fixed; top:0; left:0; width:100%; height:100%; }
    #loading {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background:#000; color:#fff; display:flex; flex-direction:column;
      justify-content:center; align-items:center; z-index:1000; font-size:1.1em; text-align:center;
    }
    .spinner {
      border:4px solid #333; border-top:4px solid gold; border-radius:50%;
      width:50px; height:50px; animation:spin 1s linear infinite; margin:20px;
    }
    @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
    #legend {
      position: fixed; bottom: 20px; left:0; width:100%; text-align:center;
      color:white; font-size:1.2em; pointer-events:none; z-index:10;
      background: rgba(0,0,0,0.5); padding:8px;
    }
    .fallback {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.95); color:white; display:none; flex-direction:column;
      justify-content:center; align-items:center; text-align:center; padding:20px; z-index:2000;
    }
    .btn {
      background: gold; color: #8B4513; border:none; padding:12px 22px; margin:8px; border-radius:20px; font-size:1em; cursor:pointer; text-decoration:none;
    }
  </style>

  <!-- three.js (r128) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <!-- GLTFLoader non-module (declarado global como THREE.GLTFLoader) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/loaders/GLTFLoader.js"></script>
  <!-- MindAR UMD -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image-three.prod.js"></script>
</head>

<body>
  <div id="loading">
    <div class="spinner"></div>
    <p>Carregando experiÃªncia de Realidade Aumentada...</p>
    <p id="status">Inicializando...</p>
  </div>

  <div id="container"></div>
  <div id="legend"></div>

  <div class="fallback" id="fallback">
    <h2>ðŸŽµ Retiro Espiritual - ExperiÃªncia Digital</h2>
    <p>A funcionalidade de RA estÃ¡ temporariamente indisponÃ­vel.</p>
    <p><strong>Todo o conteÃºdo espiritual estÃ¡ disponÃ­vel abaixo:</strong></p>
    <div style="margin:30px 0;">
      <a href="prayers.html" class="btn">ðŸ“– Ver Todas as OraÃ§Ãµes</a>
      <a href="https://open.spotify.com/playlist/SUA_PLAYLIST_AQUI" class="btn" target="_blank">ðŸŽµ Playlist Spotify</a>
    </div>
    <p style="color:#ccc; margin-top:20px;"><em>"A oraÃ§Ã£o Ã© o encontro da sede de Deus com a nossa sede"</em></p>
  </div>

  <script>
    // Iniciar quando window carregar
    window.addEventListener('load', () => initializeAR());

    async function initializeAR() {
      const loading = document.getElementById('loading');
      const status = document.getElementById('status');
      const container = document.getElementById('container');
      const legend = document.getElementById('legend');
      const fallback = document.getElementById('fallback');

      function updateStatus(text) { status.textContent = text; console.log(text); }
      function showFallback() { loading.style.display = 'none'; fallback.style.display = 'flex'; }

      if (typeof THREE === 'undefined') { updateStatus('âŒ THREE.js nÃ£o carregou'); showFallback(); return; }
      if (typeof MindARThree === 'undefined') { updateStatus('âŒ MindAR nÃ£o carregou'); showFallback(); return; }

      // Detecta GLTFLoader (script non-module registra THREE.GLTFLoader)
      let GLTFLoaderClass = null;
      if (THREE && THREE.GLTFLoader) GLTFLoaderClass = THREE.GLTFLoader;
      else if (typeof GLTFLoader !== 'undefined') GLTFLoaderClass = GLTFLoader;
      else { updateStatus('âŒ GLTFLoader nÃ£o encontrado'); showFallback(); return; }

      try {
        updateStatus('âœ… Bibliotecas carregadas - Verificando arquivos...');

        // Arquivos essenciais
        const filesToCheck = [
          './targets.mind',
          './assets/models/altar-compressed.glb',
          './assets/models/livro-compressed.glb'
        ];

        // VerificaÃ§Ã£o simples (usa GET por compatibilidade)
        for (const f of filesToCheck) {
          try {
            const res = await fetch(f);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            console.log(`âœ… ${f} encontrado`);
          } catch (err) {
            console.error(`âŒ ${f} nÃ£o encontrado:`, err);
            updateStatus(`âŒ Arquivo nÃ£o encontrado: ${f}`);
            showFallback();
            return;
          }
        }

        updateStatus('âœ… Arquivos verificados - Iniciando MindAR...');

        // Instanciar MindAR
        const mindarThree = new MindARThree({
          container: container,
          imageTargetSrc: "./targets.mind",
        });

        const { renderer, scene, camera } = mindarThree;
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.domElement.style.width = '100%';
        renderer.domElement.style.height = '100%';

        updateStatus('âœ… MindAR configurado - Carregando modelos...');

        const loader = new GLTFLoaderClass();

        // Anchor e grupos
        const anchor = mindarThree.addAnchor(0);
        const hubGroup = new THREE.Group(); // grupo com todos os itens do hub
        anchor.group.add(hubGroup);

        // Guardar referÃªncia ao altar root, transformaÃ§Ãµes originais
        let altarRoot = null;
        let altarOriginal = null;
        let altarFocused = false;

        // Aid: achar o nÃ³ raiz do modelo (procuramos flag userData.modelRoot)
        function findModelRoot(obj) {
          let cur = obj;
          while (cur && !cur.userData.modelRoot && cur.parent) cur = cur.parent;
          return cur;
        }

        let modelsLoaded = 0;
        const totalModels = 3;
        function onModelLoaded(name) {
          modelsLoaded++;
          updateStatus(`Carregando modelos... (${modelsLoaded}/${totalModels})`);
          console.log(`âœ… ${name} carregado`);
          if (modelsLoaded === totalModels) updateStatus('âœ… Todos os modelos carregados!');
        }

        // --- Altar
        loader.load('./assets/models/altar-compressed.glb',
          function(gltf) {
            const model = gltf.scene;
            model.scale.set(0.4, 0.4, 0.4);
            model.position.set(0, 0, 0);
            model.userData.modelRoot = true;
            model.traverse(child => {
              if (child.isMesh) {
                child.userData.clickable = true;
                child.userData.type = 'altar';
              }
            });
            hubGroup.add(model);
            altarRoot = model;
            altarOriginal = {
              position: model.position.clone(),
              rotation: model.rotation.clone(),
              scale: model.scale.clone()
            };
            onModelLoaded('Altar');
          },
          undefined,
          function(err) { console.error('âŒ Erro ao carregar altar:', err); onModelLoaded('Altar (com erro)'); }
        );

        // --- Livro
        loader.load('./assets/models/livro-compressed.glb',
          function(gltf) {
            const model = gltf.scene;
            model.scale.set(0.5, 0.5, 0.5);
            model.position.set(1.5, 0.3, 0);
            model.rotation.set(0, Math.PI / 4, 0);
            model.userData.modelRoot = true;
            model.traverse(child => {
              if (child.isMesh) {
                child.userData.clickable = true;
                child.userData.type = 'book';
              }
            });
            hubGroup.add(model);
            onModelLoaded('Livro');
          },
          undefined,
          function(err) { console.error('âŒ Erro ao carregar livro:', err); onModelLoaded('Livro (com erro)'); }
        );

        // --- Spotify button (mesh)
        const spotifyGeometry = new THREE.CylinderGeometry(0.35, 0.35, 0.18, 32);
        const spotifyMaterial = new THREE.MeshStandardMaterial({
          color: 0x1DB954, transparent: true, opacity: 0.95, side: THREE.DoubleSide
        });
        const spotifyButton = new THREE.Mesh(spotifyGeometry, spotifyMaterial);
        spotifyButton.position.set(-1.5, 0.3, 0);
        spotifyButton.rotation.set(Math.PI / 2, 0, 0);
        spotifyButton.userData.clickable = true;
        spotifyButton.userData.type = 'spotify';
        hubGroup.add(spotifyButton);
        onModelLoaded('Spotify');

        // luz (para materiais Standard)
        const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
        scene.add(hemi);
        const dir = new THREE.DirectionalLight(0xffffff, 0.6);
        dir.position.set(0, 1, 0);
        scene.add(dir);

        // Eventos do anchor
        anchor.onTargetFound = () => {
          legend.textContent = "Marcador detectado! Clique nos objetos para interagir.";
          console.log('ðŸŽ¯ Marcador encontrado');
        };
        anchor.onTargetLost = () => {
          legend.textContent = "";
          console.log('ðŸ‘» Marcador perdido');
        };

        // Raycaster para cliques
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        renderer.domElement.addEventListener('click', (event) => {
          // usar anchor.group.visible para saber se o marcador estÃ¡ ativo
          if (!anchor.group.visible) {
            console.log('Clique ignorado - marcador nÃ£o visÃ­vel');
            return;
          }

          const rect = renderer.domElement.getBoundingClientRect();
          mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
          mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
          raycaster.setFromCamera(mouse, camera);

          // coletar objetos clicÃ¡veis
          const clickableObjects = [];
          scene.traverse(obj => {
            if (obj.userData && obj.userData.clickable) clickableObjects.push(obj);
          });

          const intersects = raycaster.intersectObjects(clickableObjects, true);
          if (intersects.length === 0) return;

          const clicked = intersects[0].object;
          const type = clicked.userData.type;
          console.log('Clicou em:', type);

          // achar root apropriado
          const root = findModelRoot(clicked) || clicked.parent || clicked;

          // Comportamentos por tipo
          if (type === 'altar') {
            // toggle mode: se nÃ£o estiver em foco, entrar; senÃ£o voltar
            if (!altarFocused && altarRoot) {
              // esconder tudo exceto altar
              hubGroup.children.forEach(child => {
                if (child !== altarRoot) child.visible = false;
              });
              // aproximar e aumentar altar (em relaÃ§Ã£o ao marker)
              altarRoot.position.set(0, 0.0, 0); // manter no centro do marker
              altarRoot.scale.set(0.8, 0.8, 0.8);
              altarFocused = true;
              legend.textContent = "âœ¨ Meditando no altar â€” clique novamente para voltar";
            } else if (altarFocused && altarRoot) {
              // restaurar hub
              hubGroup.children.forEach(child => child.visible = true);
              // restaurar transformaÃ§Ãµes originais
              altarRoot.position.copy(altarOriginal.position);
              altarRoot.rotation.copy(altarOriginal.rotation);
              altarRoot.scale.copy(altarOriginal.scale);
              altarFocused = false;
              legend.textContent = "Marcador detectado! Clique nos objetos para interagir.";
            }
            return;
          }

          if (type === 'book') {
            legend.textContent = "ðŸ“– Abrindo oraÃ§Ãµes...";
            setTimeout(() => { window.location.href = 'prayers.html'; }, 600);
            return;
          }

          if (type === 'spotify') {
            legend.textContent = "ðŸŽµ Abrindo Spotify...";
            setTimeout(() => { window.open('https://open.spotify.com/playlist/SUA_PLAYLIST_AQUI', '_blank'); }, 600);
            return;
          }
        });

        updateStatus('âœ… ConfiguraÃ§Ã£o completa - Iniciando cÃ¢mera...');
        await mindarThree.start();
        updateStatus('âœ… RA Pronta! Aponte para o marcador.');
        // esconder loading
        setTimeout(() => { loading.style.display = 'none'; }, 1200);

        // render loop
        renderer.setAnimationLoop(() => { renderer.render(scene, camera); });

        // resize
        window.addEventListener('resize', () => {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        });

      } catch (error) {
        console.error('âŒ Erro fatal:', error);
        updateStatus('âŒ Erro: ' + (error && error.message ? error.message : error));
        showFallback();
      }
    }

    // Timeout de seguranÃ§a: mostra fallback se ainda no loading
    setTimeout(() => {
      const loading = document.getElementById('loading');
      if (loading && loading.style.display !== 'none') {
        document.getElementById('fallback').style.display = 'flex';
        loading.style.display = 'none';
      }
    }, 12000);
  </script>
</body>
</html>
